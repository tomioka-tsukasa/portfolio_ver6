# メタボール シェーダー実装 解説

このディレクトリには、メタボールのインナーグロー効果を実現するカスタムシェーダーが含まれています。

## 概要

このシェーダープログラムは、メタボール（マーチングキューブスで生成される流体的な形状）に、視点に依存したインナーグロー効果を適用します。視点の角度によって透明度が変化し、立体感のある美しい表現を実現します。

## シェーダーファイル構成

- `vertex.glsl` - 頂点シェーダー（頂点の位置計算と法線計算）
- `fragment.glsl` - フラグメントシェーダー（最終的な色の決定）

## Uniforms（外部から渡される変数）

### viewVector (vec3)
- **用途**: カメラの位置座標
- **なぜ必要？**: インナーグロー効果を実現するため
- **仕組み**:
  - 各頂点の法線ベクトルとカメラへの方向ベクトルの内積を計算
  - 視線とサーフェスの角度によって透明度を変化させる
  - 正面から見ると透明度が低く（内部が見える）、斜めから見ると不透明（エッジが強調される）

### uColor (vec3)
- **用途**: ベースとなる発光色
- **デフォルト値**: `0x42a9f1`（青系）
- **効果**: グローエフェクトの基本色を決定

### uResolution (vec2)
- **用途**: 画面の解像度（幅、高さ）
- **使用箇所**: フラグメントシェーダーでグラデーション計算
- **仕組み**: `gl_FragCoord.xy / uResolution` で正規化座標を取得

### uPos (float)
- **用途**: アニメーション用のパラメータ（現在未使用）
- **将来の拡張**: 時間による色変化やエフェクトの変化に使用可能

## 頂点シェーダー（vertex.glsl）の動作

```glsl
void main() {
    // 1. UV座標をフラグメントシェーダーに渡す
    vUv = uv;

    // 2. 頂点の世界座標変換
    vec4 modelPosition = modelMatrix * vec4(position, 1.0);
    vec4 viewPosition = viewMatrix * modelPosition;
    vec4 projectionPosition = projectionMatrix * viewPosition;
    gl_Position = projectionPosition;

    // 3. インナーグロー効果の計算
    vec3 nNomal = normalize(normal);        // 正規化された法線ベクトル
    vec3 nViewVec = normalize(viewVector);  // 正規化されたカメラ方向ベクトル
    opacity = dot(nNomal, nViewVec);        // 内積計算（-1.0 ～ 1.0）
    opacity = 1.0 - abs(opacity * 1.3);    // インナーグロー効果
}
```

### インナーグロー計算の詳細

1. **法線ベクトル（normal）**: サーフェスの向きを表す
2. **視線ベクトル（viewVector）**: カメラから頂点への方向
3. **内積計算**: 2つのベクトルの角度を計算
   - 内積 = 1.0: 視線と法線が同じ方向（真正面）
   - 内積 = 0.0: 視線と法線が垂直（エッジ部分）
   - 内積 = -1.0: 視線と法線が反対方向（裏面）
4. **透明度変換**: `1.0 - abs(opacity * 1.3)`
   - 正面（内積が大きい）→ 透明度高い（内部が見える）
   - エッジ（内積が小さい）→ 透明度低い（境界が強調される）

## フラグメントシェーダー（fragment.glsl）の動作

```glsl
void main() {
    vec2 uv = vUv;

    // スクリーン座標を正規化（0.0-1.0）
    vec2 dist = gl_FragCoord.xy / uResolution;

    // グラデーション色の計算
    vec3 cc = vec3(0.0, dist.x, dist.y);

    // 最終色の計算
    vec3 balck = vec3(0.0, 0.0, 0.0);
    vec3 color = mix(balck, cc, opacity);
    gl_FragColor = vec4(color, 1.0);
}
```

### 色計算の仕組み

1. **基準色**: `vec3(0.0, dist.x, dist.y)`
   - R成分: 0.0（赤なし）
   - G成分: X座標に比例（左→右で緑が増加）
   - B成分: Y座標に比例（下→上で青が増加）

2. **色の合成**: `mix(black, gradientColor, opacity)`
   - 透明度が高い部分（正面）→ 黒に近い
   - 透明度が低い部分（エッジ）→ グラデーション色が強い

## 視覚効果の説明

### インナーグロー効果とは
- **正面から見た時**: 内部が透けて見える（暗い）
- **斜めから見た時**: エッジが光って見える（明るい）
- **結果**: 物体の内部から光が漏れているような効果

### カメラ位置が重要な理由
1. **リアルタイム更新**: カメラが動くたびに視線角度が変わる
2. **動的効果**: ユーザーの視点に応じてグロー効果が変化
3. **立体感**: 平面的なオブジェクトに立体感を与える

## 実装における注意点

### パフォーマンス
- シェーダーは GPU で並列実行されるため高速
- カメラ位置の更新は毎フレーム必要

### カスタマイズ可能な部分
1. **グロー強度**: `opacity * 1.3` の係数を変更
2. **色の計算**: `vec3(0.0, dist.x, dist.y)` を変更
3. **ベース色**: `uColor` の値を変更

## 数学的背景

### ベクトルの内積
```
dot(A, B) = |A| * |B| * cos(θ)
```
- θ: 2つのベクトル間の角度
- 正規化ベクトル同士なら: `dot(A, B) = cos(θ)`

### フレネル効果
このシェーダーは、光学のフレネル効果を簡略化したものです：
- 浅い角度（グレージング角）では反射が強い
- 深い角度（法線方向）では透過が強い

## 参考リンク
- [元記事](https://misora.main.jp/blog/archives/896)
- Three.js Marching Cubes サンプル
- WebGL シェーダー入門